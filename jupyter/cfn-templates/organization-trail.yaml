AWSTemplateFormatVersion: '2010-09-09'
Description: Creates an organizational trail
Resources:
  TrailBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  TrailBucketPolicy:
    Type: 'AWS::S3::BucketPolicy'
    Properties:
      Bucket: !Ref TrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: AWSCloudTrailAclCheck
          Effect: Allow
          Principal:
            Service: [
              'cloudtrail.amazonaws.com',
              'delivery.logs.amazonaws.com'
            ]
          Action: 's3:GetBucketAcl'
          Resource: !Sub 'arn:aws:s3:::${TrailBucket}'
        - Sid: AWSCloudTrailWrite
          Effect: Allow
          Principal:
            Service: [
              'cloudtrail.amazonaws.com',
              'delivery.logs.amazonaws.com'
            ]
          Action: 's3:PutObject'
          Resource: [
            !Sub 'arn:aws:s3:::${TrailBucket}/AWSLogs/*'
          ]
          Condition:
            StringEquals:
              's3:x-amz-acl': 'bucket-owner-full-control'

  TrailKey:
    Type: AWS::KMS::Key
    Properties: 
      Description: KMS Key used to encrypt the organizational trail
      Enabled: true
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Id: Key policy created by CloudTrail
        Statement:
        - Sid: Enable IAM User Permissions
          Effect: Allow
          Principal:
            AWS:
            - !Sub arn:aws:sts::${AWS::AccountId}:root
          Action: kms:*
          Resource: "*"
        - Sid: Allow CloudTrail to encrypt logs
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: kms:GenerateDataKey*
          Resource: "*"
          Condition:
            StringEquals:
              AWS:SourceArn: !Sub arn:aws:cloudtrail:${AWS::Region}:${AWS::AccountId}:trail/trail-${AWS::StackName} 
            StringLike:
              kms:EncryptionContext:aws:cloudtrail:arn: !Sub arn:aws:cloudtrail:*:${AWS::AccountId}:trail/*
        - Sid: Allow CloudTrail to describe key
          Effect: Allow
          Principal:
            Service: cloudtrail.amazonaws.com
          Action: kms:DescribeKey
          Resource: "*"
        - Sid: Allow principals in the account to decrypt log files
          Effect: Allow
          Principal:
            AWS: "*"
          Action:
          - kms:Decrypt
          - kms:ReEncryptFrom
          Resource: "*"
          Condition:
            StringEquals:
              kms:CallerAccount: !Ref AWS::AccountId
            StringLike:
              kms:EncryptionContext:aws:cloudtrail:arn: !Sub arn:aws:cloudtrail:*:${AWS::AccountId}:trail/*
        - Sid: Allow alias creation during setup
          Effect: Allow
          Principal:
            AWS: "*"
          Action: kms:CreateAlias
          Resource: "*"
          Condition:
            StringEquals:
              kms:CallerAccount: !Ref AWS::AccountId
              kms:ViaService: !Sub ec2.${AWS::Region}.amazonaws.com
        - Sid: Enable cross account log decryption
          Effect: Allow
          Principal:
            AWS: "*"
          Action:
          - kms:Decrypt
          - kms:ReEncryptFrom
          Resource: "*"
          Condition:
            StringEquals:
              kms:CallerAccount: !Ref AWS::AccountId
            StringLike:
              kms:EncryptionContext:aws:cloudtrail:arn: !Sub arn:aws:cloudtrail:*:${AWS::AccountId}:trail/*
      MultiRegion: false


  Trail:
    DependsOn:
    - TrailBucketPolicy
    Type: 'AWS::CloudTrail::Trail'
    Properties:
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsOrganizationTrail: true
      IsMultiRegionTrail: true
      S3BucketName: !Ref TrailBucket
      TrailName: !Sub trail-${AWS::StackName} 
      KMSKeyId: !GetAtt TrailKey.Arn
      EnableLogFileValidation: true
      EventSelectors: 
        - DataResources: 
            - Type: AWS::S3::Object
              Values: 
                - arn:aws:s3

Outputs:
  TrailBucket:
    Description: The name of the bucket that holds the organization trail.
    Value: !Ref TrailBucket  
  TrailArn:
    Description: The arn of the organizational trail.
    Value: !GetAtt Trail.Arn