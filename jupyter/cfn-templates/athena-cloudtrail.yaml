AWSTemplateFormatVersion: '2010-09-09'
Description: Creates the IAM role for the active-runbooks account creation
Parameters:
  TrailBucket:
    Type: String
    Description: The Name of the S3 bucket that contains the CloudTrail logs.
  S3Prefix:
    Type: String
    Description: The prefix in the S3 bucket that contains the CloudTrail logs.
  DatabaseName:
    Type: String
    Description: The database name for the Athena tables
  TableName:
    Type: String
    Description: The table name for the Athena CloudTrail tables
Resources:
  CFNDatabaseAuditLogs:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Ref DatabaseName 
        Description: Database to hold tables for CloudTrail data
  CFNTableCloudTrail:
    DependsOn: CFNDatabaseAuditLogs
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref DatabaseName
      TableInput:
        Name: !Ref TableName
        Description: The organization wide cloudtrail logs
        TableType: EXTERNAL_TABLE
        Parameters:
          "projection.enabled": "true"
          "projection.enabled": "true" 
          "storage.location.template": "s3://organization-trail-trailbucket-1nou196wsxixy/AWSLogs/o-krcf45heml/${accountid}/CloudTrail/${region}/${timestamp}/"
          "projection.accountid.type": "injected"
          "projection.region.type": "enum"
          "projection.region.values": "us-east-1,us-east-2,us-west-1,us-west-2"
          "projection.timestamp.format": "yyyy/MM/dd"
          "projection.timestamp.interval": "1"
          "projection.timestamp.interval.unit": "DAYS"
          "projection.timestamp.range": "2020/01/01,NOW"
          "projection.timestamp.type": "date"
        PartitionKeys:
        # Data is partitioned by month
        - Name: accountid
          Type: string
        - Name: region
          Type: string
        - Name: timestamp
          Type: string                    
        StorageDescriptor:
          Columns:
            - Name: eventversion
              Type: string
              Comment: ''
            - Name: useridentity
              Type: struct<Type:string,principalid:string,arn:string,accountid:string,invokedby:string,accesskeyid:string,userName:string,sessioncontext:struct<attributes:struct<mfaauthenticated:string,creationdate:string>,sessionissuer:struct<Type:string,principalId:string,arn:string,accountId:string,userName:string>>>
              Comment: ''
            - Name: eventtime
              Type: string
              Comment: ''
            - Name: eventsource
              Type: string
              Comment: ''
            - Name: eventName
              Type: string
              Comment: ''
            - Name: awsregion
              Type: string
              Comment: ''
            - Name: sourceipaddress
              Type: string
              Comment: ''
            - Name: useragent
              Type: string
              Comment: ''
            - Name: errorcode
              Type: string
              Comment: ''
            - Name: errormessage
              Type: string
              Comment: ''
            - Name: requestparameters
              Type: string
              Comment: ''
            - Name: responseelements
              Type: string
              Comment: ''
            - Name: additionaleventdata
              Type: string
              Comment: ''
            - Name: requestid
              Type: string
              Comment: ''
            - Name: eventid
              Type: string
              Comment: ''
            - Name: resources
              Type: array<struct<ARN:string,accountId:string,Type:string>>
              Comment: ''
            - Name: eventType
              Type: string
              Comment: ''
            - Name: apiversion
              Type: string
              Comment: ''
            - Name: readonly
              Type: string
              Comment: ''
            - Name: recipientaccountid
              Type: string
              Comment: ''
            - Name: serviceeventdetails
              Type: string
              Comment: ''
            - Name: sharedeventid
              Type: string
              Comment: ''
            - Name: vpcendpointid
              Type: string
              Comment: ''
          Location: !Sub s3://${TrailBucket}/AWSLogs/${AWS::AccountId}/CloudTrail/
          InputFormat: com.amazon.emr.cloudtrail.CloudTrailInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Compressed: false
          SerdeInfo:
            SerializationLibrary: com.amazon.emr.hive.serde.CloudTrailSerde
            Parameters:
              serialization.format: '1'
          StoredAsSubDirectories: false
 
Outputs:
  CFNTableCloudTrail:
    Description: The Athena table used to query cloudtrail logs
    Value: !Ref CFNTableCloudTrail  
